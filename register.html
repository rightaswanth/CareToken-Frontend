<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register Clinic - CareToken</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body class="bg-background flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl bg-surface rounded-xl shadow-lg p-8 border border-border">
      <div class="text-center mb-8">
        <img src="/logo.png" alt="CareToken" class="h-12 w-auto mx-auto mb-4">
        <h1 class="text-2xl font-bold text-text-main mb-2">Register Clinic</h1>
        <p class="text-text-muted text-sm">Create an account for your clinic</p>
      </div>

      <!-- Progress Bar -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-medium text-primary" id="step-label-1">Basic Info</span>
          <span class="text-xs font-medium text-text-muted" id="step-label-2">Contact</span>
          <span class="text-xs font-medium text-text-muted" id="step-label-3">Professional</span>
        </div>
        <div class="w-full bg-border rounded-full h-2">
          <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 33%" id="progress-bar"></div>
        </div>
      </div>

      <form id="registerForm" class="space-y-6">
        <!-- Step 1: Basic Info -->
        <div id="step-1" class="step-content">
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-text-main border-b border-border pb-2">Basic Information</h3>
            
            <div>
              <label for="name" class="block text-sm font-medium text-text-main mb-1">Clinic Name</label>
              <input type="text" id="name" name="name" required
                class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                placeholder="e.g. Sunrise Hospital">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="clinic_type" class="block text-sm font-medium text-text-main mb-1">Clinic Type</label>
                <select id="clinic_type" name="clinic_type" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm bg-surface">
                  <option value="">Select Type</option>
                  <option value="Hospital">Hospital</option>
                  <option value="Private Clinic">Private Clinic</option>
                  <option value="Poly-clinic">Poly-clinic</option>
                  <option value="Specialty Center">Specialty Center</option>
                </select>
              </div>
              <div>
                <label for="year_of_establishment" class="block text-sm font-medium text-text-main mb-1">Year Est.</label>
                <input type="number" id="year_of_establishment" name="year_of_establishment" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                  placeholder="e.g. 2010">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Contact & Location -->
        <div id="step-2" class="step-content hidden">
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-text-main border-b border-border pb-2">Contact & Location</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="phone" class="block text-sm font-medium text-text-main mb-1">Phone Number</label>
                <input type="tel" id="phone" name="phone" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                  placeholder="+91 98765 43210">
              </div>
              <div>
                <label for="city" class="block text-sm font-medium text-text-main mb-1">City</label>
                <select id="city" name="city" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm bg-surface">
                  <option value="">Select City</option>
                  <option value="Kochi">Kochi</option>
                  <option value="Bangalore">Bangalore</option>
                  <option value="Mumbai">Mumbai</option>
                  <option value="Delhi">Delhi</option>
                  <option value="Chennai">Chennai</option>
                  <option value="Hyderabad">Hyderabad</option>
                  <option value="Trivandrum">Trivandrum</option>
                  <option value="Calicut">Calicut</option>
                </select>
              </div>
            </div>

            <div>
              <label for="address" class="block text-sm font-medium text-text-main mb-1">Address</label>
              <textarea id="address" name="address" rows="2" required
                class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                placeholder="Full street address"></textarea>
            </div>
          </div>
        </div>

        <!-- Step 3: Professional Details -->
        <div id="step-3" class="step-content hidden">
          <div class="space-y-4">
            <h3 class="text-lg font-medium text-text-main border-b border-border pb-2">Professional Details</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="clinic_registration_number" class="block text-sm font-medium text-text-main mb-1">Reg. Number</label>
                <input type="text" id="clinic_registration_number" name="clinic_registration_number" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                  placeholder="Reg. No.">
              </div>
              <div>
                <label for="issued_authority" class="block text-sm font-medium text-text-main mb-1">Issued Authority</label>
                <input type="text" id="issued_authority" name="issued_authority" required
                  class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
                  placeholder="Authority Name">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-text-main mb-2">Specialities Offered</label>
              <div class="grid grid-cols-2 gap-2">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="General Medicine" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">General Medicine</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="Cardiology" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">Cardiology</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="Pediatrics" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">Pediatrics</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="Orthopedics" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">Orthopedics</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="Dermatology" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">Dermatology</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="speciality_offer" value="Neurology" class="form-checkbox text-primary rounded focus:ring-primary">
                  <span class="ml-2 text-sm text-text-main">Neurology</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-between pt-4">
          <button type="button" id="prevBtn" class="hidden px-6 py-2.5 border border-border rounded-lg text-text-main font-medium hover:bg-background transition-colors text-sm">
            Back
          </button>
          <button type="button" id="nextBtn" class="ml-auto px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors shadow-sm text-sm">
            Next
          </button>
          <button type="submit" id="submitBtn" class="hidden ml-auto px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors shadow-sm text-sm">
            Register Clinic
          </button>
        </div>
      </form>

      <div class="mt-6 text-center text-sm text-text-muted">
        Already have an account? 
        <a href="/clinic-login.html" class="text-primary hover:text-primary-dark font-medium">Login here</a>
      </div>
    </div>
    <script type="module" src="/main.js"></script>
    <script>
      let currentStep = 1;
      const totalSteps = 3;

      const progressBar = document.getElementById('progress-bar');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const registerForm = document.getElementById('registerForm');

      function updateUI() {
        // Update Progress Bar
        const progress = (currentStep / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;

        // Show/Hide Steps
        for (let i = 1; i <= totalSteps; i++) {
          const step = document.getElementById(`step-${i}`);
          const label = document.getElementById(`step-label-${i}`);
          
          if (i === currentStep) {
            step.classList.remove('hidden');
            label.classList.add('text-primary');
            label.classList.remove('text-text-muted');
          } else {
            step.classList.add('hidden');
            label.classList.remove('text-primary');
            label.classList.add('text-text-muted');
          }
        }

        // Show/Hide Buttons
        if (currentStep === 1) {
          prevBtn.classList.add('hidden');
        } else {
          prevBtn.classList.remove('hidden');
        }

        if (currentStep === totalSteps) {
          nextBtn.classList.add('hidden');
          submitBtn.classList.remove('hidden');
        } else {
          nextBtn.classList.remove('hidden');
          submitBtn.classList.add('hidden');
        }
      }

      function validateStep(step) {
        const stepEl = document.getElementById(`step-${step}`);
        const inputs = stepEl.querySelectorAll('input, select, textarea');
        let isValid = true;

        inputs.forEach(input => {
          if (input.hasAttribute('required') && !input.value.trim()) {
            isValid = false;
            input.classList.add('border-red-500');
            // Remove error class on input
            input.addEventListener('input', () => {
              input.classList.remove('border-red-500');
            }, { once: true });
          }
        });

        return isValid;
      }

      nextBtn.addEventListener('click', () => {
        if (validateStep(currentStep)) {
          if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
          }
        }
      });

      prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateUI();
        }
      });

      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (validateStep(currentStep)) {
          // Collect data
          const formData = new FormData(registerForm);
          
          // Handle checkboxes for speciality_offer
          const specialities = [];
          document.querySelectorAll('input[name="speciality_offer"]:checked').forEach(checkbox => {
            specialities.push(checkbox.value);
          });

          const payload = {
            name: formData.get('name'),
            clinic_type: formData.get('clinic_type'),
            year_of_establishment: parseInt(formData.get('year_of_establishment')),
            phone: formData.get('phone'),
            city: formData.get('city'),
            address: formData.get('address'),
            clinic_registration_number: formData.get('clinic_registration_number'),
            issued_authority: formData.get('issued_authority'),
            speciality_offer: specialities
          };

          try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
            
            const response = await fetch('/api/v1/clinics/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const data = await response.json();
              const credentials = data.admin_credentials;
              
              // Show success message with credentials
              const container = document.querySelector('.max-w-2xl');
              container.innerHTML = `
                <div class="text-center">
                  <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <h2 class="text-2xl font-bold text-text-main mb-2">Registration Successful!</h2>
                  <p class="text-text-muted mb-6">Your clinic has been registered. Please save these credentials for login.</p>
                  
                  <div class="bg-surface border border-border rounded-lg p-6 mb-6 text-left">
                    <div class="mb-4">
                      <label class="block text-xs text-text-muted uppercase tracking-wide font-semibold mb-1">Clinic Slug (Required for Login)</label>
                      <div class="flex items-center justify-between bg-background p-3 rounded border border-border">
                        <code class="text-primary font-mono text-lg">${data.clinic.slug}</code>
                        <button onclick="navigator.clipboard.writeText('${data.clinic.slug}')" class="text-text-muted hover:text-primary">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                      </div>
                    </div>
                    <div class="mb-4">
                      <label class="block text-xs text-text-muted uppercase tracking-wide font-semibold mb-1">Username</label>
                      <div class="flex items-center justify-between bg-background p-3 rounded border border-border">
                        <code class="text-primary font-mono text-lg">${credentials.username}</code>
                        <button onclick="navigator.clipboard.writeText('${credentials.username}')" class="text-text-muted hover:text-primary">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-text-muted uppercase tracking-wide font-semibold mb-1">Password</label>
                      <div class="flex items-center justify-between bg-background p-3 rounded border border-border">
                        <code class="text-primary font-mono text-lg">${credentials.password}</code>
                        <button onclick="navigator.clipboard.writeText('${credentials.password}')" class="text-text-muted hover:text-primary">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-sm text-yellow-800">
                    <p class="font-medium">Important:</p>
                    <p>These credentials will not be shown again. Please copy and store them securely.</p>
                  </div>

                  <a href="/clinic-login.html" class="inline-block w-full bg-primary text-white font-medium py-3 rounded-lg hover:bg-primary-dark transition-colors shadow-sm">
                    Go to Login
                  </a>
                </div>
              `;
            } else {
              const errorData = await response.json();
              alert('Registration failed: ' + (errorData.detail ? JSON.stringify(errorData.detail) : 'Unknown error'));
              submitBtn.disabled = false;
              submitBtn.textContent = 'Register Clinic';
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Register Clinic';
          }
        }
      });

      // Initialize
      updateUI();
    </script>
