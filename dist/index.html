<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Login - CareToken</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" crossorigin src="/assets/main-BTBPOQB7.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/main-wkl5NDq_.css">
  </head>
  <body class="bg-background flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-surface rounded-xl shadow-lg p-8 border border-border">
      <div class="text-center mb-8">
        <img src="/logo.png" alt="CareToken" class="h-12 w-auto mx-auto mb-4">
        <h1 class="text-2xl font-bold text-text-main mb-2">Patient Login</h1>
        <p class="text-text-muted text-sm">Book appointments with top doctors</p>
      </div>

      <!-- Step 1: Mobile Number -->
      <form id="mobileForm" class="space-y-5">
        <div>
          <label for="mobile" class="block text-sm font-medium text-text-main mb-1">Mobile Number</label>
          <input type="tel" id="mobile" name="mobile" required pattern="[0-9]{10}"
            class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm"
            placeholder="Enter 10 digit number">
        </div>

        <button type="submit"
          class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2.5 rounded-lg transition-colors shadow-sm text-sm">
          Send OTP
        </button>
      </form>

      <!-- Step 2: OTP (Hidden initially) -->
      <form id="otpForm" class="space-y-5 hidden">
        <div class="text-center mb-4">
          <p class="text-sm text-text-muted">OTP sent to <span id="displayMobile" class="font-medium text-text-main"></span></p>
          <button type="button" id="changeMobile" class="text-xs text-primary hover:underline mt-1">Change Number</button>
        </div>

        <div>
          <label for="otp" class="block text-sm font-medium text-text-main mb-1">Enter OTP</label>
          <input type="text" id="otp" name="otp" required pattern="[0-9]{4}" maxlength="4"
            class="w-full px-4 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all text-sm tracking-widest text-center"
            placeholder="••••">
        </div>

        <button type="submit"
          class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2.5 rounded-lg transition-colors shadow-sm text-sm">
          Verify & Login
        </button>
      </form>

      <div class="mt-6 text-center text-sm text-text-muted">
        Are you a doctor? 
        <a href="/clinic-login.html" class="text-primary hover:text-primary-dark font-medium">Clinic Login</a>
      </div>
    </div>
    <script>
      const mobileForm = document.getElementById('mobileForm');
      const otpForm = document.getElementById('otpForm');
      const mobileInput = document.getElementById('mobile');
      const displayMobile = document.getElementById('displayMobile');
      const changeMobileBtn = document.getElementById('changeMobile');
      const sendOtpBtn = mobileForm.querySelector('button[type="submit"]');
      const verifyOtpBtn = otpForm.querySelector('button[type="submit"]');

      mobileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const mobile = mobileInput.value;
        
        if (mobile.length === 10) {
          try {
            sendOtpBtn.disabled = true;
            sendOtpBtn.textContent = 'Sending...';

            const response = await fetch('/api/v1/patients/request-otp', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ phone: mobile })
            });

            if (response.ok) {
              displayMobile.textContent = mobile;
              mobileForm.classList.add('hidden');
              otpForm.classList.remove('hidden');
              // Focus OTP input
              setTimeout(() => document.getElementById('otp').focus(), 100);
            } else {
              const errorData = await response.json();
              alert('Failed to send OTP: ' + (errorData.detail ? JSON.stringify(errorData.detail) : 'Unknown error'));
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          } finally {
            sendOtpBtn.disabled = false;
            sendOtpBtn.textContent = 'Send OTP';
          }
        }
      });

      otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const otp = document.getElementById('otp').value;
        const mobile = mobileInput.value;

        if (otp.length === 4) {
          try {
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.textContent = 'Verifying...';

            const response = await fetch('/api/v1/patients/verify-otp', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ phone: mobile, otp: otp })
            });

            if (response.ok) {
              const data = await response.json();
              // Save user session
              localStorage.setItem('userToken', data.access_token);
              localStorage.setItem('userMobile', mobile);
              localStorage.setItem('userId', data.patient_id);
              localStorage.setItem('userName', data.name);
              
              window.location.href = '/select-city.html';
            } else {
              const errorData = await response.json();
              alert('Invalid OTP: ' + (errorData.detail ? JSON.stringify(errorData.detail) : 'Unknown error'));
            }
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          } finally {
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.textContent = 'Verify & Login';
          }
        }
      });

      changeMobileBtn.addEventListener('click', () => {
        otpForm.classList.add('hidden');
        mobileForm.classList.remove('hidden');
        mobileInput.focus();
      });
    </script>
  </body>
</html>
