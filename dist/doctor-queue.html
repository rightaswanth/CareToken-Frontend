<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Queue Management - CareToken</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" crossorigin src="/assets/main-BTBPOQB7.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/main-wkl5NDq_.css">
  </head>
  <body class="bg-background font-sans text-text-main">
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-surface border border-border shadow-lg rounded-lg p-4 transform translate-x-full transition-transform duration-300 z-50 flex items-start max-w-sm hidden">
      <div class="flex-shrink-0 pt-0.5">
        <svg class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="ml-3 w-0 flex-1">
        <p class="text-sm font-medium text-text-main">Success!</p>
        <p class="mt-1 text-sm text-text-muted">Operation successful.</p>
      </div>
      <div class="ml-4 flex-shrink-0 flex">
        <button class="bg-transparent rounded-md inline-flex text-text-muted hover:text-text-main focus:outline-none" onclick="hideToast()">
          <span class="sr-only">Close</span>
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar (Same as Dashboard) -->
      <aside class="w-64 bg-surface border-r border-border hidden md:flex flex-col z-10">
        <div class="h-16 flex items-center px-6 border-b border-border">
          <img src="/logo.png" alt="CareToken" class="h-8 w-auto mr-2">
          <span class="text-xl font-bold text-primary">CareToken</span>
        </div>
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
          <a href="/dashboard.html" class="flex items-center px-4 py-3 text-sm font-medium text-text-muted hover:bg-background hover:text-text-main rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            Dashboard
          </a>
          <a href="/appointments.html" class="flex items-center px-4 py-3 text-sm font-medium bg-primary/10 text-primary rounded-lg">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Appointments
          </a>
           <a href="/doctors.html" class="flex items-center px-4 py-3 text-sm font-medium text-text-muted hover:bg-background hover:text-text-main rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            Doctors
          </a>
          <a href="#" class="flex items-center px-4 py-3 text-sm font-medium text-text-muted hover:bg-background hover:text-text-main rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            Patients
          </a>
          <a href="#" class="flex items-center px-4 py-3 text-sm font-medium text-text-muted hover:bg-background hover:text-text-main rounded-lg transition-colors">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col overflow-hidden">


        <!-- Header -->
        <header class="h-16 bg-surface border-b border-border flex items-center justify-between px-6 z-10">
           <div class="flex items-center">
             <a href="/appointments.html" class="mr-4 text-text-muted hover:text-text-main">
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
             </a>
             <h1 class="text-lg font-semibold text-text-main">Manage Queue</h1>
           </div>
           <div class="flex items-center space-x-4">
             <div class="flex items-center space-x-2">
              <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-sm">DR</div>
              <span id="clinic-name-display" class="text-sm font-medium text-text-main hidden sm:block">Clinic</span>
            </div>
           </div>
        </header>

        <!-- Queue Manager -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-background">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-full h-auto">
            
            <!-- Left Column: Current Status & Controls -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Status Card -->
              <div class="bg-surface rounded-xl shadow-sm border border-border p-6 md:p-8 text-center">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
                  <div class="text-left w-full md:w-auto">
                    <h2 class="text-xl font-bold text-text-main">Current Consultation</h2>
                    <p class="text-text-muted text-sm">Token currently with the doctor</p>
                  </div>
                  <div class="flex items-center space-x-2 w-full md:w-auto justify-center md:justify-end">
                    <div id="consultation-controls" class="flex items-center flex-wrap justify-center gap-2">
                      <!-- Controls will be injected here -->
                    </div>
                  </div>
                </div>

                <div class="py-4 md:py-8">
                  <div class="text-5xl md:text-6xl font-bold text-primary mb-2" id="current-token-display">--</div>
                  <div class="text-xl font-medium text-text-main mb-1" id="current-patient-name">No Active Consultation</div>
                  <div class="text-sm text-text-muted mb-1" id="current-patient-age"></div>
                  <span class="text-sm text-text-muted"></span>
                </div>

                <div class="flex justify-center space-x-4 mt-6">
                  <button id="hold-btn" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors font-medium text-sm flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Hold
                  </button>
                  <button id="complete-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-sm flex items-center shadow-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Complete & Call Next
                  </button>
                </div>
              </div>

              <!-- Create Appointment -->
              <div id="booking-form-container" class="bg-surface rounded-xl shadow-sm border border-border p-6">
                <h3 class="text-lg font-bold text-text-main mb-4">Book Appointment</h3>
                <form id="create-appt-form" class="space-y-4">
                  <!-- Type Selector -->
                  <div>
                    <label class="block text-sm font-medium text-text-main mb-2">Appointment Type</label>
                    <div class="flex space-x-4">
                      <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="apptType" value="normal" checked class="text-primary focus:ring-primary">
                        <span class="text-sm text-text-main">Normal</span>
                      </label>
                      <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="apptType" value="emergency" class="text-red-600 focus:ring-red-600">
                        <span class="text-sm text-text-main">Emergency</span>
                      </label>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-text-main mb-1">Patient Name</label>
                    <input type="text" name="patientName" required class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm">
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-text-main mb-1">Age</label>
                      <input type="number" name="age" required min="0" class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-text-main mb-1">Gender</label>
                      <select name="gender" required class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm bg-white">
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                  </div>

                  <!-- Optional Fields Container -->
                  <div id="optional-fields" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-text-main mb-1">Phone Number</label>
                        <input type="tel" name="phone" required pattern="[0-9]{10}" class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm">
                      </div>
                      <div>
                         <label class="block text-sm font-medium text-text-main mb-1">Available Slots</label>
                         <select name="preferred_slot" required class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm bg-white">
                           <option value="">Select a slot</option>
                         </select>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-text-main mb-1">Reason</label>
                      <textarea name="reason" rows="2" class="w-full px-3 py-2 border border-border rounded-lg focus:ring-2 focus:ring-primary outline-none text-sm"></textarea>
                    </div>
                  </div>

                  <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2.5 rounded-lg transition-colors shadow-sm">
                    Confirm Booking
                  </button>
                </form>
              </div>
            </div>

            <!-- Right Column: Queue List -->
            <div class="bg-surface rounded-xl shadow-sm border border-border flex flex-col lg:h-full h-[500px] overflow-hidden">
              <div class="p-4 border-b border-border bg-gray-50">
                <h3 class="font-bold text-text-main">Waiting Queue</h3>
                <p class="text-xs text-text-muted mt-1"><span id="waiting-count">0</span> Patients Waiting</p>
              </div>
              
              <div class="flex-1 overflow-y-auto p-4 space-y-3" id="queue-list">
                <!-- Queue items populated by JS -->
              </div>

              <!-- Hold Queue -->
              <div class="p-4 border-t border-border bg-yellow-50 hidden" id="hold-queue-container">
                <h3 class="font-bold text-yellow-800 text-sm mb-2">On Hold (<span id="hold-count">0</span>)</h3>
                <div class="space-y-2" id="hold-queue-list">
                  <!-- Hold items -->
                </div>
              </div>
            </div>

          </div>
        </main>
      </div>
    </div>
    <script>
      // Set Clinic Name
      const clinicName = localStorage.getItem('selectedClinicName');
      if (clinicName) {
        document.getElementById('clinic-name-display').textContent = clinicName;
      }

      // Toast Logic

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const title = toast.querySelector('p.font-medium');
        const desc = toast.querySelector('p.text-text-muted');
        const iconContainer = toast.querySelector('div.flex-shrink-0');
        
        desc.textContent = message;

        if (type === 'error') {
          title.textContent = 'Error';
          title.className = 'text-sm font-medium text-red-600';
          iconContainer.innerHTML = `
            <svg class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`;
        } else {
          title.textContent = 'Success!';
          title.className = 'text-sm font-medium text-text-main';
          iconContainer.innerHTML = `
            <svg class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`;
        }

        toast.classList.remove('hidden');
        // Small delay to allow display:block to apply before transform
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 10);

        setTimeout(() => {
          hideToast();
        }, 3000);
      }

      window.hideToast = () => {
        const toast = document.getElementById('toast');
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 300); // Wait for transition
      };

      // State
      let currentToken = null;
      let queue = [];
      let onHoldQueue = [];

      // Fetch Queue
      async function fetchQueue(doctorId) {
        try {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;

          const response = await fetchWithAuth(`/api/v1/appointments/queue?doctor_id=${doctorId}&date=${dateStr}`, {
            headers: {
              // 'Authorization' handled by fetchWithAuth
            }
          });

          if (response.ok) {
            const data = await response.json();
            
            // New structure: { queue: [], on_hold: [] }
            // API returns 'state' instead of 'status'
            
            // 1. Waiting Queue
            const waitingList = data.queue || [];
            queue = waitingList.filter(item => ['created', 'scheduled', 'waiting', 'checked_in'].includes(item.state));
            
            // 2. On Hold Queue
            const holdList = data.on_hold || [];
            onHoldQueue = holdList.map(item => ({
              number: item.token_display || item.token_number,
              name: item.patient_name,
              age: item.patient_age,
              type: item.is_emergency ? 'emergency' : 'normal',
              status: item.state,
              id: item.id
            }));

            // 3. Current Consulting (Check both lists or if API provides separate field? Assuming it's in queue with status consulting)
            // Actually, usually 'consulting' might be in 'queue' list or separate. 
            // Let's assume 'consulting' is in the main 'queue' array returned by API, or we check both.
            // Based on user request "queue listing response structure is changed", likely 'queue' contains active/waiting.
            
            const allItems = [...(data.queue || []), ...(data.on_hold || [])];
            const consulting = allItems.find(item => ['consulting', 'in_progress'].includes(item.state));
            
            if (consulting) {
              currentToken = {
                id: consulting.id,
                number: consulting.token_display || consulting.token_number,
                name: consulting.patient_name,
                age: consulting.patient_age,
                type: consulting.is_emergency ? 'emergency' : 'normal',
                status: consulting.state
              };
            } else {
              currentToken = null;
            }

            // Map waiting queue items for display
            queue = queue.map(item => ({
              number: item.token_display || item.token_number,
              name: item.patient_name,
              age: item.patient_age,
              type: item.is_emergency ? 'emergency' : 'normal',
              status: item.state,
              id: item.id
            }));

            renderQueue();
            updateCurrentDisplay();
          } else {
            console.error('Failed to fetch queue');
            showToast('Failed to fetch queue', 'error');
          }
        } catch (error) {
          console.error('Error fetching queue:', error);
        }
      }

      // DOM Elements
      const queueList = document.getElementById('queue-list');
      const holdQueueList = document.getElementById('hold-queue-list');
      const holdQueueContainer = document.getElementById('hold-queue-container');
      const holdCount = document.getElementById('hold-count');
      const currentTokenDisplay = document.getElementById('current-token-display');
      const currentPatientName = document.getElementById('current-patient-name');
      const currentPatientAge = document.getElementById('current-patient-age');
      const waitingCount = document.getElementById('waiting-count');
      const createForm = document.getElementById('create-appt-form');
      const slotSelect = createForm.querySelector('select[name="preferred_slot"]');

      // Fetch Slots
      async function fetchSlots(doctorId) {
        try {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;

          const response = await fetchWithAuth(`/api/v1/doctors/${doctorId}/slots?date=${dateStr}`, {
            headers: {
              // 'Authorization' handled by fetchWithAuth
            }
          });
          if (response.ok) {
            const responseData = await response.json();
            slotSelect.innerHTML = '<option value="">Select a slot</option>';
            
            let slotsArray = [];
            if (Array.isArray(responseData)) {
                slotsArray = responseData;
            } else if (responseData.daily_slots && Array.isArray(responseData.daily_slots)) {
                slotsArray = responseData.daily_slots;
            } else if (responseData.data && Array.isArray(responseData.data)) {
                slotsArray = responseData.data;
            }

            // Flatten if daily_slots structure (array of days with slots)
            // Filter for current date if daily_slots structure
            // API returns date in YYYY-MM-DD format usually
            
            let flatSlots = [];
            slotsArray.forEach(item => {
                // If item has 'date' property, check if it matches today
                if (item.date && item.date !== dateStr) {
                    return;
                }

                if (item.slots && Array.isArray(item.slots)) {
                    flatSlots = flatSlots.concat(item.slots);
                } else {
                    // If it's a direct slot object (no date wrapper or date matches), add it
                    // But wait, if it's a direct slot list (responseData is array of slots), 
                    // we assume the API respected the ?date param.
                    // If responseData is daily_slots, we must filter.
                    flatSlots.push(item);
                }
            });

            if (flatSlots.length === 0) {
                 const option = document.createElement('option');
                 option.disabled = true;
                 option.textContent = "No slots available";
                 slotSelect.appendChild(option);
            } else {
                flatSlots.forEach(slot => {
                  const option = document.createElement('option');
                  let slotValue, slotLabel;

                  if (typeof slot === 'string') {
                      slotValue = slot;
                      slotLabel = new Date(slot).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                  } else if (slot.start_time) {
                      slotValue = slot.start_time;
                      slotLabel = new Date(slot.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                  } else {
                      return; 
                  }

                  option.value = slotValue;
                  option.textContent = slotLabel;
                  slotSelect.appendChild(option);
                });
            }
          } else {
            console.error('Failed to fetch slots');
          }
        } catch (error) {
          console.error('Error fetching slots:', error);
        }
      }

      function renderQueue() {
        // 1. Render Waiting Queue
        queueList.innerHTML = '';
        waitingCount.textContent = queue.length;

        queue.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = `p-4 rounded-lg border ${item.type === 'emergency' ? 'bg-red-50 border-red-200' : 'bg-white border-border'} flex justify-between items-center group`;
          div.innerHTML = `
            <div class="flex items-center">
              <div class="mr-4 text-center min-w-[3rem]">
                <span class="block text-lg font-bold ${item.type === 'emergency' ? 'text-red-600' : 'text-primary'}">${item.number}</span>
              </div>
              <div>
                <p class="font-medium text-text-main">${item.name}</p>
                <div class="flex items-center text-xs text-text-muted mt-0.5">
                  ${item.age ? `<span class="whitespace-nowrap">Age: ${item.age}</span>` : ''}
                  ${item.age ? '<span class="mx-2">â€¢</span>' : ''}
                  <span class="capitalize whitespace-nowrap ${item.type === 'emergency' ? 'text-red-600 font-medium' : ''}">${item.type}</span>
                </div>
              </div>
            </div>
            <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="holdPatient(${index})" class="p-1 text-amber-600 hover:bg-amber-100 rounded" title="Hold">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </button>
              <button onclick="consultNow(${index})" class="p-1 text-green-600 hover:bg-green-100 rounded" title="Consult Now">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              </button>
            </div>
          `;
          queueList.appendChild(div);
        });

        // 2. Render Hold Queue
        if (onHoldQueue.length > 0) {
          holdQueueContainer.classList.remove('hidden');
          holdCount.textContent = onHoldQueue.length;
          holdQueueList.innerHTML = '';
          
          onHoldQueue.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg border border-yellow-200 bg-yellow-50/50 flex justify-between items-center group`;
            div.innerHTML = `
              <div class="flex items-center">
                <div class="mr-3 text-center min-w-[2.5rem]">
                  <span class="block text-md font-bold text-yellow-700">${item.number}</span>
                </div>
                <div>
                  <p class="font-medium text-sm text-text-main">${item.name}</p>
                  <div class="flex items-center text-xs text-text-muted mt-0.5">
                     ${item.age ? `<span class="whitespace-nowrap">Age: ${item.age}</span>` : ''}
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <button onclick="consultHeld(${index})" class="p-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" title="Consult Now">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
                 <button onclick="cancelAppointment('${item.id}')" class="p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors" title="Cancel">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
            `;
            holdQueueList.appendChild(div);
          });
        } else {
          holdQueueContainer.classList.add('hidden');
        }
      }

      function updateCurrentDisplay() {
        if (currentToken) {
          currentTokenDisplay.textContent = currentToken.number;
          currentPatientName.textContent = currentToken.name;
          currentPatientAge.textContent = currentToken.age ? `Age: ${currentToken.age}` : '';
        } else {
          currentTokenDisplay.textContent = "--";
          currentPatientName.textContent = "No Active Consultation";
          currentPatientAge.textContent = "";
        }
      }

      // Actions
      // Actions
      async function updateAppointmentStatus(appointmentId, status) {
        try {
          const response = await fetchWithAuth(`/api/v1/appointments/${appointmentId}/status`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization' handled by fetchWithAuth
            },
            body: JSON.stringify({ status: status })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update status');
          }
          return true;
        } catch (error) {
          console.error('Error updating status:', error);
          showToast(error.message, 'error');
          return false;
        }
      }

      window.holdPatient = async (index) => {
        const item = queue[index];
        if (item && item.id) {
            const success = await toggleHold(item.id);
            if (success) {
                showToast(`Put ${item.name} on hold`);
                fetchQueue(doctorId);
            }
        }
      };

      async function startConsultation(patient) {
         // 1. Complete current if exists
         if (currentToken && currentToken.id) {
            const success = await updateAppointmentStatus(currentToken.id, 'completed');
            if (!success) return;
         }

         // 2. Start new
         if (patient && patient.id) {
             const success = await updateAppointmentStatus(patient.id, 'consulting');
             if (success) {
                 showToast(`Started consultation for ${patient.name}`);
                 fetchQueue(doctorId); // Refresh all
             }
         }
      }

      window.consultNow = async (index) => {
        await startConsultation(queue[index]);
      };

      window.consultHeld = async (index) => {
        await startConsultation(onHoldQueue[index]);
      };

      window.cancelAppointment = async (appointmentId) => {
          if(!confirm('Are you sure you want to cancel this appointment?')) return;
          const success = await updateAppointmentStatus(appointmentId, 'cancelled');
          if (success) {
              showToast('Appointment cancelled');
              fetchQueue(doctorId);
          }
      };

      async function completeCurrent() {
          if (!currentToken || !currentToken.id) {
              showToast('No active consultation to complete', 'warning');
              return false;
          }
          const success = await updateAppointmentStatus(currentToken.id, 'completed');
          if (success) {
              showToast('Consultation completed');
              return true;
          }
          return false;
      }

      async function callNext() {
          if (queue.length === 0) {
              showToast('Queue is empty', 'info');
              fetchQueue(doctorId); // Just refresh to be sure
              return;
          }
          
          // Find first waiting (already sorted by fetchQueue/renderQueue logic)
          const nextPatient = queue[0];
          if (nextPatient && nextPatient.id) {
              const success = await updateAppointmentStatus(nextPatient.id, 'consulting');
              if (success) {
                  showToast(`Started consultation for ${nextPatient.name}`);
                  fetchQueue(doctorId);
              }
          }
      }

      document.getElementById('complete-btn').addEventListener('click', async () => {
          const completed = await completeCurrent();
          if (completed) {
              await callNext();
          }
      });

      async function toggleHold(appointmentId) {
        try {
          const response = await fetchWithAuth(`/api/v1/appointments/${appointmentId}/toggle-hold`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization' handled by fetchWithAuth
            }
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to toggle hold status');
          }
          return true;
        } catch (error) {
          console.error('Error toggling hold:', error);
          showToast(error.message, 'error');
          return false;
        }
      }

      window.resumeHold = async (index) => {
        const item = onHoldQueue[index];
        if (item && item.id) {
            // Resume hold means toggling it back (or setting status to waiting/consulting?)
            // The API is toggle-hold, so calling it should remove hold.
            // But does it put it back to waiting or consulting?
            // Assuming toggle-hold puts it back to 'waiting' or 'consulting' based on previous state or logic.
            // Let's assume it puts it back to waiting/consulting.
            // If we want to consult immediately, we might need to call consultNow logic after toggle?
            // Or maybe toggle-hold just removes hold flag.
            
            const success = await toggleHold(item.id);
            if (success) {
                showToast(`Resumed ${item.name}`);
                fetchQueue(doctorId);
            }
        }
      };

      document.getElementById('hold-btn').addEventListener('click', async () => {
        if (!currentToken || !currentToken.id) {
            showToast('No active consultation to hold', 'warning');
            return;
        }
        
        const success = await toggleHold(currentToken.id);
        if (success) {
            showToast('Consultation put on hold');
            fetchQueue(doctorId);
        }
      });

      // Toggle Logic
      const typeRadios = document.querySelectorAll('input[name="apptType"]');
      const optionalFields = document.getElementById('optional-fields');
      const optionalInputs = optionalFields.querySelectorAll('input, textarea, select');

      typeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === 'emergency') {
            optionalFields.classList.add('hidden');
            optionalInputs.forEach(input => input.required = false);
          } else {
            optionalFields.classList.remove('hidden');
            optionalInputs.forEach(input => {
              if(input.name !== 'reason') input.required = true;
            });
          }
        });
      });

      // Initialize state (Normal is checked by default)
      // Ensure reason is not required by default if it wasn't
      createForm.querySelector('textarea[name="reason"]').required = false;


      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = createForm.querySelector('button[type="submit"]');
        const formData = new FormData(createForm);
        const type = formData.get('apptType');
        
        let payload = {
          doctor_id: doctorId,
          tenant_id: localStorage.getItem('selectedTenantId'),
          patient: {
            name: formData.get('patientName'),
            age: parseInt(formData.get('age')),
            gender: formData.get('gender')
          }
        };

        if (type === 'normal') {
          payload.preferred_slot = formData.get('preferred_slot'); // Already ISO from select value
          payload.reason = formData.get('reason');
          payload.patient.phone = formData.get('phone');
        } else {
          // Emergency: Send defaults or omit
          // Assuming API requires these fields, we send defaults.
          // If API allows omission, we can remove them.
          // Let's send current time for slot and "Emergency" for reason.
          payload.preferred_slot = new Date().toISOString();
          payload.reason = "Emergency";
          payload.patient.phone = "0000000000"; // Placeholder
          payload.is_emergency = true; // If API supports this flag
        }

        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Booking...';

          const response = await fetch('/api/v1/appointments/admin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            showToast('Appointment booked successfully!', 'success');
            createForm.reset();
            // Reset UI to normal state
            document.querySelector('input[value="normal"]').checked = true;
            optionalFields.classList.remove('hidden');
            optionalInputs.forEach(input => {
               if(input.name !== 'reason') input.required = true;
            });
            fetchQueue(doctorId);
          } else {
            const error = await response.json();
            showToast('Booking failed: ' + (error.detail || 'Unknown error'), 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('An error occurred', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Confirm Booking';
        }
      });

      // Consultation Status Logic
      const controlsContainer = document.getElementById('consultation-controls');

      async function fetchDoctorStatus() {
        try {
          const tenantId = localStorage.getItem('selectedTenantId');
          console.log('Fetching status for doctor:', doctorId, 'Tenant:', tenantId);
          
          if (!tenantId) {
             console.error('No tenant ID found');
             controlsContainer.innerHTML = '<span class="text-red-500 text-sm">Error: No Clinic Selected</span>';
             return;
          }

          const response = await fetchWithAuth(`/api/v1/doctors/${tenantId}/doctors`, {
             headers: {
              // 'Authorization' handled by fetchWithAuth
            }
          });
          
          if (!response.ok) throw new Error('Failed to fetch doctor status');
          
          const doctors = await response.json();
          console.log('Doctors fetched:', doctors.length);
          
          const doctor = doctors.find(d => d.id === doctorId);
          
          if (doctor) {
            console.log('Doctor found:', doctor.name, 'Consulting:', doctor.is_consulting);
            const isValidTime = await checkCurrentTimeInSlot(doctorId);
            renderConsultationControls(doctor.is_consulting, isValidTime);
          } else {
            console.error('Doctor not found in list');
            controlsContainer.innerHTML = '<span class="text-red-500 text-sm">Doctor not found</span>';
          }
        } catch (error) {
          console.error('Error fetching status:', error);
          controlsContainer.innerHTML = '<span class="text-red-500 text-sm">Error loading status</span>';
          showToast('Failed to fetch consultation status', 'error');
        }
      }

      async function checkCurrentTimeInSlot(doctorId) {
        try {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const dateStr = `${year}-${month}-${day}`;

          const response = await fetchWithAuth(`/api/v1/doctors/${doctorId}/slots?date=${dateStr}`, {
              headers: {
                  // 'Authorization' handled by fetchWithAuth
              }
          });

          if (!response.ok) return false;

          const responseData = await response.json();
          let slotsArray = [];
          
          if (Array.isArray(responseData)) {
              slotsArray = responseData;
          } else if (responseData.daily_slots && Array.isArray(responseData.daily_slots)) {
              slotsArray = responseData.daily_slots;
          }

          if (slotsArray.length === 0) return false;

          // Flatten slots if nested in daily_slots structure
          let allSlots = [];
          slotsArray.forEach(dayData => {
              if (dayData.slots && Array.isArray(dayData.slots)) {
                  allSlots = allSlots.concat(dayData.slots);
              } else if (dayData.start_time && dayData.end_time) {
                  // Direct slot object
                  allSlots.push(dayData);
              }
          });

          const now = new Date();
          const currentTime = now.getTime();

          return allSlots.some(slot => {
              const start = new Date(slot.start_time).getTime();
              const end = new Date(slot.end_time).getTime();
              return currentTime >= start && currentTime <= end;
          });

        } catch (error) {
          console.error('Error checking slots:', error);
          return false;
        }
      }

      function renderConsultationControls(isConsulting, isValidTime) {
        // Removed bookingForm toggling logic
        
        if (isConsulting) {
          controlsContainer.innerHTML = `
            <span class="text-sm font-medium text-text-muted mr-2">Status:</span>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 mr-3">Consulting</span>
            <button onclick="toggleConsultation(false)" class="bg-red-100 hover:bg-red-200 text-red-700 text-sm font-medium py-1.5 px-3 rounded-lg transition-colors">
              Stop Consultation
            </button>
          `;
        } else {
          if (isValidTime) {
            controlsContainer.innerHTML = `
              <span class="text-sm font-medium text-text-muted mr-2">Status:</span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 mr-3">Offline</span>
              <button onclick="toggleConsultation(true)" class="bg-green-100 hover:bg-green-200 text-green-700 text-sm font-medium py-1.5 px-3 rounded-lg transition-colors">
                Start Consultation
              </button>
            `;
          } else {
            controlsContainer.innerHTML = `
              <span class="text-sm font-medium text-text-muted mr-2">Status:</span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 mr-3">Offline</span>
              <div class="group relative inline-block">
                <button disabled class="bg-gray-100 text-gray-400 text-sm font-medium py-1.5 px-3 rounded-lg cursor-not-allowed">
                  Start Consultation
                </button>
                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                  Available only during scheduled slots
                </div>
              </div>
            `;
          }
        }
      }

      window.toggleConsultation = async (newStatus) => {
        try {
          const response = await fetch(`/api/v1/doctors/${doctorId}/consulting-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: JSON.stringify({ is_consulting: newStatus })
          });

          if (!response.ok) throw new Error('Failed to update status');

          showToast(`Consultation ${newStatus ? 'started' : 'stopped'} successfully`);
          const isValidTime = await checkCurrentTimeInSlot(doctorId);
          renderConsultationControls(newStatus, isValidTime);
        } catch (error) {
          console.error('Error updating status:', error);
          showToast('Failed to update status', 'error');
        }
      };

      // Auth Check
      const accessToken = localStorage.getItem('accessToken');
      if (!accessToken) {
        window.location.href = '/index.html';
      }

      // Helper for 401 handling
      async function fetchWithAuth(url, options = {}) {
        const headers = {
          'Authorization': `Bearer ${accessToken}`,
          ...options.headers
        };
        
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
          console.error('Unauthorized: Redirecting to login');
          localStorage.removeItem('accessToken');
          localStorage.removeItem('selectedTenantId');
          window.location.href = '/index.html';
          return response; // Or throw error
        }
        
        return response;
      }

      // Init
      const urlParams = new URLSearchParams(window.location.search);
      const doctorId = urlParams.get('id');
      if (doctorId) {
        // Use fetchWithAuth or just rely on the global check + individual error handling for now.
        // Since refactoring all fetches is large, let's just add the initial check and maybe a listener for 401s if possible, 
        // or just update the existing functions to handle 401 explicitly if we want to be robust.
        // For now, the initial check covers "missing token". 
        // The "invalid token" case needs handling in the catch blocks or a wrapper.
        // Let's stick to the initial check for now and maybe add a simple 401 check in the existing functions.
        
        fetchSlots(doctorId);
        fetchDoctorStatus();
        fetchQueue(doctorId);
        
        // Poll queue every 5 seconds
        setInterval(() => {
            fetchQueue(doctorId);
        }, 5000);
      } else {
         // Handle missing ID
         showToast('No doctor ID provided', 'error');
      }
    </script>
  </body>
</html>
